<!doctype html>

<html lang="ja">
<head>
	<meta charset="utf-8">

	<title>w2v</title>
	<meta name="description" content="w2v">
	<meta name="author" content="tibaraki">

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<style>
		body {
			font-size: 9pt;
		}
		line {
			stroke: #999;
			stroke-opacity: 0.4;
		}
	</style>
</head>

<body>
	<div>
		検索語:
		<input id="word" type="text" style="width: 200px;" onchange="ns.eh_ga1_update();" value="AI"></input>
		上位N件を除外(NW図):
		<input id="index" type="text" style="width: 60px;" onchange="ns.eh_ga1_update();" value="0"></input>
		基準日(NW図):
		<select id="calender" onchange="ns.eh_ga1_update();"></select>
		
		<span id="msg" style="color: red;"></span>
	</div>

	<hr>
	
	<svg id="ga1" width="600" height="600" style="border: 1px solid gray; display: inline-block;"></svg>	
	
	<script>
	
	//namespace
	var ns = {};

	//grapharea1
	(function() {
		var svg = d3.select("#ga1");
		var width = svg.attr("width")
		var height = svg.attr("height")
		
		var lines = svg.append("g").selectAll("line");
		var circles = svg.append("g").selectAll("circle");
		var labels = svg.append("g").selectAll("text");
		
		var simulation = d3.forceSimulation()
			.force("link",		d3.forceLink().id(function(d){return d.id;}))
			.force("charge",	d3.forceManyBody().strength(-200))
			.force("center",	d3.forceCenter(width/2, height/2))
			.force("collide",	d3.forceCollide().radius(20))
			.on("tick", ticked);
		function ticked() {
			lines
				.attr("x1", function(d){return d.source.x;})
				.attr("y1", function(d){return d.source.y;})
				.attr("x2", function(d){return d.target.x;})
				.attr("y2", function(d){return d.target.y;});
			circles
				.attr("cx", function(d){return d.x;})
				.attr("cy", function(d){return d.y;});
			labels
				.attr("x", function(d){return d.x;})
				.attr("y", function(d){return d.y;});
		}
		
		function update(word,date,index) {
			d3.json("/words/vec?date="+date+"&word="+word+"&index="+index, function(err, json){
				if (err) throw err;
				if ("error" in json) throw json.error;
				var nodes = json.nodes;
				var links = json.links;
				
				circles = circles.data([]);
				circles.exit().remove();
				circles = circles.data(nodes).enter().append("circle")
					.attr("r",		10)
					.attr("fill",	function(d){return d3.schemeCategory20c[d.group*5%20];});

				labels = labels.data([]);
				labels.exit().remove();
				labels = labels.data(nodes).enter().append("text")
					.text(function(d){return d.id;});
				
				lines = lines.data([]);
				lines.exit().remove();
				lines = lines.data(links).enter().append("line");
				
				simulation.nodes(nodes);
				simulation.force("link").links(links);
				simulation.alpha(1).restart();
			});
		}
		
		ns.ga1_update = update;
	})();
	
	//eventhandler
	(function() {
		function ga1_update() {
			var word = d3.select("#word");
			var index = d3.select("#index");
			var calender = d3.select("#calender");
			ns.ga1_update(word.node().value, calender.node().value, index.node().value);
		}
		ns.eh_ga1_update = ga1_update;
	})();

	//main
	(function() {
		d3.json("/calender", function(err, json){
			if (err) throw err;
			var calender = d3.select("#calender");
			calender.selectAll("option").data(json).enter()
				.append("option")
				.text(function(d){return d;});
			ns.eh_ga1_update();
		});
	})();

	</script>
</body>
</html>

