<!doctype html>

<html lang="ja">
<head>
	<meta charset="utf-8">

	<title>w2v</title>
	<meta name="description" content="w2v">
	<meta name="author" content="tibaraki">

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<style>
		body {
			font-size: 9pt;
		}
		.links line {
			stroke: #999;
			stroke-opacity: 0.6;
		}
		.nodes circle {
			stroke: #fff;
			stroke-width: 1.5px;
		}
	</style>
</head>

<body>
	<div>
		検索語:<input type="text" id="wordbox" style="width: 200px;" onchange="update(q_date, this.value, q_index); updaterank(this.value);"></input>
		上位N件を除外(NW図):<input type="text" id="indexbox" style="width: 60px;" onchange="update(q_date, q_word, this.value);"></input>
		基準日(NW図):<select id="calender" onchange="update(this.options[this.selectedIndex].value, q_word, q_index);"></select>
		<span id="msg" style="color: red;"></span>
	</div>
	
	<hr>
	
	<div style="vertical-align: top;">
		<svg width="600" height="600" style="border: 1px solid gray; display: inline-block;"></svg>	
		<div style="display: inline-block; vertical-align: top;">
			　出現数上位：
			<ol id="ranking" style="list-style-type: decimal-leading-zero;">
			</ol>
		</div>
	</div>
	
	<script>
	
	var q_word = "AI";
	var q_index = "0";
	var q_date = "";
	
	var svg = d3.select("svg"),
		width = +svg.attr("width"),
		height = +svg.attr("height");
	
	var color = d3.scaleOrdinal(d3.schemeCategory20);
	var simulation = d3.forceSimulation()
	    .force("link", d3.forceLink().id(function(d) { return d.id; }))
	    .force("charge", d3.forceManyBody().strength(-200))
	    .force("center", d3.forceCenter(width / 2, height / 2))
	    .force("collide", d3.forceCollide().radius(20))
		.on("tick", ticked);
	var link = svg.append("g")
		.attr("class", "links")
		.selectAll("line");
	var node = svg.append("g")
		.attr("class", "nodes")
		.selectAll("circle");
	var label = svg.append("g")
		.attr("class", "labels")
		.selectAll("text");
	var working = 0;
	
	function ticked() {
		if (working == 1) {
			link
				.attr("x1", function(d) { return d.source.x; })
				.attr("y1", function(d) { return d.source.y; })
				.attr("x2", function(d) { return d.target.x; })
				.attr("y2", function(d) { return d.target.y; });
			node
				.attr("cx", function(d) { return d.x; })
				.attr("cy", function(d) { return d.y; });
			label
				.attr("x", function(d) { return d.x; })
				.attr("y", function(d) { return d.y; });
		}
	}
	function dragstarted(d) {
		if (!d3.event.active) simulation.alphaTarget(0.3).restart();
		d.fx = d.x;
		d.fy = d.y;
	}
	function dragged(d) {
		d.fx = d3.event.x;
		d.fy = d3.event.y;
	}
	function dragended(d) {
		if (!d3.event.active) simulation.alphaTarget(0);
		d.fx = null;
		d.fy = null;
	}
	svg.call(d3.zoom()
			.scaleExtent([-8, 8])
			.on("zoom", zoom));
	function zoom() {
		link.attr("transform", d3.event.transform);
		node.attr("transform", d3.event.transform);
		label.attr("transform", d3.event.transform);
	}
	function update(date, word, index) {
		d3.json("/words/vec?date="+date+"&word="+word+"&index="+index, function(err, json){
			if (err) throw err;
			
			if ("error" in json) {
				console.log(json.error);
				d3.select("#msg").text(json.error);
				return;
			}
			
			var nodes = json.nodes;
			var links = json.links;
			link = link.data([]);
			link.exit().remove();
			node = node.data([]);
			node.exit().remove();
			label = label.data([]);
			label.exit().remove();
			link = link.data(links);
			link = link.enter().append("line")
				.attr("stroke-width", function(d) { return 1.5; });
			node = node.data(nodes);
			node = node.enter().append("circle")
				.attr("r", 10)
				.attr("fill", function(d) { return color(d.group); })
				.call(d3.drag()
					.on("start", dragstarted)
					.on("drag", dragged)
					.on("end", dragended));
			label = label.data(nodes);
			label = label.enter().append("text")
				.attr("text-anchor", "start")
				.attr("dominant-baseline", "hanging")
				.attr("fill", "black")
				.attr("font-size", "15")
				.text(function(d) { return d.id; })
			simulation.nodes(nodes);
			simulation.force("link").links(links);
			simulation.alpha(1).restart();
			
			working = 1;
			d3.select("#msg").text("");
			q_date = date;
			q_word = word;
			q_index = index;
		});
	}
	
	d3.select("#wordbox").attr("value", q_word);
	d3.select("#indexbox").attr("value", q_index);

	d3.json("/calender", function(err, json){
		if (err) throw err;
		d3.select("#calender").selectAll("option").data(json).enter()
			.append("option")
			.text(function(d) { return d; });
		q_date = json[0];
		update(q_date, q_word, q_index);
		updaterank(q_word);
	});

	function updaterank(word) {
		d3.json("/words/count?word="+word, function(err, json){
			if (err) throw err;
			
			if ("error" in json) {
				console.log(json.error);
				d3.select("#msg").text(json.error);
				return;
			}
			
			d3.select("#ranking").selectAll("li").remove();
			d3.select("#ranking").selectAll("li").data(json).enter()
				.append("li")
				.text(function(d) { return d[0] + "(" + d[1] + ")"; });
		});
	}
	
	</script>
</body>
</html>


